rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função para verificar se o usuário é admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.tipo_usuario.trim() == 'admin';
    }
    
    // Função para verificar se é o próprio usuário
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Usuários - podem ler e atualizar próprios dados, admins podem tudo
    match /usuarios/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Rifas - leitura pública, escrita apenas para admins
    match /rifas/{rifaId} {
      allow read: if true; // Rifas são públicas
      allow write: if isAdmin();
    }
    
    // Números - leitura pública (para mostrar disponibilidade), escrita para admins e usuários logados
    match /numeros/{numeroId} {
      allow read: if true; // Público para mostrar números disponíveis
      allow create: if isAdmin(); // Apenas admins podem criar números
      allow update: if request.auth != null; // Qualquer usuário logado pode atualizar (reservar/liberar)
      allow delete: if isAdmin();
    }
    
    // Pedidos - usuários podem ler e atualizar próprios pedidos, admins podem tudo
    match /pedidos/{pedidoId} {
      allow read: if request.auth != null; // Qualquer usuário logado pode ler pedidos (para verificação de expiração)
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.id_usuario;
      allow update: if request.auth != null; // Qualquer usuário logado pode atualizar (para marcar expirado)
      allow delete: if isAdmin();
    }
    
    // Configurações do sistema - apenas admins
    match /configuracoes/{configId} {
      allow read, write: if isAdmin();
    }
    
    // Logs de auditoria - apenas leitura para admins
    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Apenas via Cloud Functions
    }
    
    // Relatórios - apenas para admins
    match /relatorios/{relatorioId} {
      allow read, write: if isAdmin();
    }
  }
}
